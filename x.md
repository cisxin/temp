# stock

    MA10:MA(C,10),LINETHICK2;//10周期均线
    MA30:MA(C,20),LINETHICK2;//30周期均线
    MA120:MA(C,60),CIRCLEDOT,COLORGREEN,LINETHICK3;
    N:=9;
    M1:=9;
    M2:=3;
    RSV:=(CLOSE-LLV(LOW,N))/(HHV(HIGH,N)-LLV(LOW,N))*100;
    KK:=SMA(RSV,M1,1);
    D:=SMA(KK,M2,1);
    J:=3*KK-2*D;
    BK0:=BARSLASTCOUNT(C>MA30&&EVERY(C>=MA10,4))=1;
    SK0:=BARSLASTCOUNT(C<MA30&&EVERY(C<MA10,4))=1;
    BP0:=BARSLASTCOUNT(EVERY(C>=MA10,4))=1;
    SP0:=BARSLASTCOUNT(EVERY(C<MA10,4))=1;
    K:=C<MA120&&CROSSDOWN(MA10,MA30);
    K2:=C<MA120&&CROSSUP(MA10,MA30);
    P:=C>MA120&&CROSSUP(MA10,MA30);
    P2:=C>MA120&&CROSSDOWN(MA10,MA30);
    KDJ0:=KK>70&&D>70&&CROSSDOWN(KK,D);
    KDJ02:=KK<30&&D<30&&CROSSUP(KK,D);
    KTEXT(K,0,C,1,COLORRED,'空'),COLORGREEN;
    KTEXT(K2,0,C,1,COLORYELLOW,'偏强'),COLORBLUE;
    KTEXT(P,0,C,1,COLORRED,'多'),RGB(255,0,128);
    KTEXT(P2,0,C,1,COLORYELLOW,'偏弱'),COLORYELLOW;
    KTEXT(KDJ0,0,C,1,COLORYELLOW,'偏弱'),RGB(255,0,128);
    KTEXT(KDJ02,0,C,1,COLORYELLOW,'偏强'),RGB(255,0,128);
    Z:=ZIGZAG(HIGH,3,1);
    DRAWSL(REFX(Z>REF(Z,1),1),REF(L,BARSLAST(REFX(CROSS(Z,REF(Z,1)),1))),0,1,0,COLORGREEN),DOT; 
    DRAWSL(REFX(Z<REF(Z,1),1),REF(H,BARSLAST(REFX(CROSSDOWN(Z,REF(Z,1)),1))),0,1,0,COLORRED),DOT; 
    DRAWCOLORKLINE(C>=MA120, COLORRED,0);
    DRAWCOLORKLINE(C<MA120,COLORGREEN,0);
    //KTEXT(ISLASTBAR&&C>MA120,0,MA120,1,COLORRED,'做多为主');
    //KTEXT(ISLASTBAR&&C<MA120,0,MA120,1,COLORGREEN,'做空为主');
    KTEXT(BARSLASTCOUNT(C>MA120)=3,0,MA120,1,COLORRED,'偏强');
    KTEXT(BARSLASTCOUNT(C<MA120)=3,0,MA120,1,COLORGREEN,'偏弱');



    DIFF:=EMA(CLOSE,12)-EMA(CLOSE,26);
    DEA:=EMA(DIFF,9);
    MACD:=2*(DIFF-DEA);

    MACD_JX:=CROSS(DIFF,DEA) || DIFF > DEA;
    MACD_SX:=CROSSDOWN(DIFF,DEA) || DIFF < DEA;

    COND1:=C>O&&REF(C,1)<REF(0,1)&&MACD_JX&&MAX(O,C)>=REF(MAX(O,C),1)&&MIN(O,C)<=REF(MIN(O,C),1);
    COND11:=CONDBARS(MACD_JX,MACD_SX);
    KTEXT(COND1&&COND11>10,0,C,1,COLORRED,'趋势反转');
    COND1_P:COND1;

    //MACD_SX:=CROSSDOWN(DIFF,DEA) || DIFF < DEA;
    //COND2:=C<O&&MACD_SX&&MAX(O,C)>=REF(MAX(O,C),1)&&MIN(O,C)<=REF(MIN(O,C),1);
    //KTEXT(COND2,0,C,1,COLORGREEN,'趋势反转');
    //COND2_P:MACD_SX;

    DIFF2:=EMA(CLOSE,12)-EMA(CLOSE,26);
    DEA2:=EMA(DIFF2,9);
    MACD02:=2*(DIFF2-DEA2);
    MACD_JX2:=CROSS(DIFF2,DEA2);
    MACD_SX2:=CROSSDOWN(DIFF2,DEA2);
    UPCOND:=CROSS(DIFF2,DEA2);
    DOWNCOND:=CROSSDOWN(DIFF2,DEA2);

    //A2:=BARSLAST(REF(CROSS(DEA2,DIFF2),1));
    //顶背离:=REF(CLOSE,A2+1)<CLOSE AND REF(DIFF2,A2+1)>DIFF2 AND CROSS(DEA2,DIFF2);
    //KTEXT(顶背离,0,O,1,COLORGREEN,'顶背离');
    //M2:=MAX(MAX(MAX(O,C),REF(MAX(O,C),1)),REF(MAX(O,C),2));
    //M22:=MIN(MIN(MIN(O,C),REF(MIN(O,C),1)),REF(MIN(O,C),2));
    //M_2:=MAX(MAX(MAX(O,C),REFX(MAX(O,C),1)),REFX(MAX(O,C),2));
    //M_22:=MIN(MIN(MIN(O,C),REFX(MIN(O,C),1)),REFX(MIN(O,C),2));
    //TM1:=M_22<=M22&&M_2>=M2;
    //COND3:=MACD_SX2&&顶背离&&TM1;
    //KTEXT(COND3,0,C,1,COLORGREEN,'空头');

    A1:=BARSLAST(REF(CROSS(DIFF2,DEA2),1));
    底背离:=REF(CLOSE,A1+1)>CLOSE AND DIFF2>REF(DIFF2,A1+1) AND CROSS(DIFF2,DEA2);
    KTEXT(底背离,0,O,1,COLORRED,'底背离');
    M3:=MAX(MAX(MAX(O,C),REF(MAX(O,C),1)),REF(MAX(O,C),2));
    M32:=MIN(MIN(MIN(O,C),REF(MIN(O,C),1)),REF(MIN(O,C),2));
    M_3:=MAX(MAX(MAX(O,C),REFX(MAX(O,C),1)),REFX(MAX(O,C),2));
    M_32:=MIN(MIN(MIN(O,C),REFX(MIN(O,C),1)),REFX(MIN(O,C),2));
    TM2:=M_32-0.5<=M32&&M_3+0.5>=M3;
    COND4:=MACD_JX2&&底背离&&TM2;
    KTEXT(COND4,0,C,1,COLORRED,'多头');

    MID:MA(CLOSE,26);
    TMP2:=STD(CLOSE,26);
    TOP:MID+2*TMP2;
    BOTTOM:MID-2*TMP2;

    RCD:=COND4&&C>O&&(C>BOTTOM&&C<TOP);
    入场点:=RCD;
    KTEXT(入场点,0,C,1,COLORRED,'入场点');
    //CCD:=COND3&&C<O&&(C>BOTTOM&&C<TOP);
    //出场点:=CCD;
    //KTEXT(出场点,0,C,1,COLORGREEN,'出场点');
